{"version":3,"file":"auto-arrange-plugin.esm.js","sources":["../src/board.js","../src/cache.js","../src/auto-arrange.js","../src/index.js"],"sourcesContent":["export class Board {\n    constructor() {\n        this._cols = [];\n    }\n\n    add(columnIndex, value) {\n        if (!this._cols[columnIndex]) this._cols[columnIndex] = [];\n        \n        this._cols[columnIndex].push(value);\n    }\n\n    toArray() {\n        const normalized = Object.keys(this._cols)\n            .sort((i1, i2) => +i1 - +i2)\n            .map(key => this._cols[key]);\n\n        return normalized;\n    }\n}\n","export class Cache {\n    constructor() {\n        this._map = new WeakMap();\n    }\n\n    track(value) {\n        if (this._map.has(value)) return true;\n        this._map.set(value, true);\n    }\n}\n","import { Board } from './board';\nimport { Cache } from './cache';\n\nexport class AutoArrange {\n    constructor(editor, margin, depth, vertical, offset) {\n        this.editor = editor;\n        this.margin = margin;\n        this.depth = depth;\n        this.vertical = vertical;\n        this.offset = offset;\n    }\n\n    getNodes(node, type = 'output') {\n        const nodes = [];\n        const key = `${type}s`;\n\n        for (let io of node[key].values())\n            for (let connection of io.connections.values())\n                nodes.push(connection[type === 'input' ? 'output' : 'input'].node);\n\n        return nodes;\n    }\n\n    getNodesBoard(node, options, cache = new Cache(), board = new Board(), depth = 0) {\n        if (options.depth && depth > options.depth) return board;\n        if (options.skip && options.skip(node)) return board;\n        if (cache.track(node)) return board;\n\n        board.add(depth, node);\n\n        const outputNodes = options.substitution && options.substitution.output(node) || this.getNodes(node, 'output')\n        const inputNodes = options.substitution && options.substitution.input(node) || this.getNodes(node, 'input')\n\n        outputNodes.map(n => this.getNodesBoard(n, options, cache, board, depth + 1));\n        inputNodes.map(n => this.getNodesBoard(n, options, cache, board, depth - 1));\n\n        return board;\n    }\n\n    getNodeSize(node, vertical = this.vertical) {\n        const el = this.editor.view.nodes.get(node).el;\n\n        return vertical ? {\n            height: el.clientWidth,\n            width: el.clientHeight\n        } : {\n            width: el.clientWidth,\n            height: el.clientHeight\n        }\n    }\n\n    translateNode(node, { x, y, vertical = this.vertical }) {\n        const position = vertical?[y, x]:[x, y];\n\n        this.editor.view.nodes.get(node).translate(...position);\n        this.editor.view.updateConnections({ node });\n    }\n\n    arrange(node = this.editor.nodes[0], { margin = this.margin, vertical = this.vertical, depth = this.depth, offset = this.offset, skip, substitution }) {\n        const board = this.getNodesBoard(node, { depth, skip, substitution }).toArray();\n        const currentMargin = vertical ? { x: margin.y, y: margin.x } : margin;\n        const currentOffset = vertical ? { x: offset.y, y: offset.x } : offset;\n\n        let x = currentOffset.x;\n\n        for (let column of board) {\n            const sizes = column.map(node => this.getNodeSize(node, vertical));\n            const columnWidth  = Math.max(...sizes.map(size => size.width));\n            const fullHeight = sizes.reduce((sum, node) => sum + node.height + currentMargin.y, 0);\n\n            let y = currentOffset.y;\n\n            for (let node of column) {\n                const position = { x, y: y - fullHeight / 2, vertical };\n                const { height } = this.getNodeSize(node, vertical);\n\n                this.translateNode(node, position, vertical);\n\n                y += height + currentMargin.y;\n            }\n\n            x += columnWidth + currentMargin.x;\n        }\n    }\n}\n","import { AutoArrange } from './auto-arrange';\n\nfunction install(editor, { margin = { x: 50, y: 50 }, depth = null, vertical = false, offset = { x: 0, y: 0 } }) {\n    editor.bind('arrange');\n\n    const ar = new AutoArrange(editor, margin, depth, vertical, offset);\n\n    editor.on('arrange', ({ node, ...options }) => ar.arrange(node, options));\n\n    editor.arrange = (node, options) => {\n        console.log(`Deprecated: use editor.trigger('arrange', { node }) instead`);\n        ar.arrange(node, options);\n    }\n}\n\nexport default {\n    name: 'auto-arrange',\n    install\n}\n"],"names":["Board","_cols","columnIndex","value","push","normalized","Object","keys","sort","i1","i2","map","key","Cache","_map","WeakMap","has","set","AutoArrange","editor","margin","depth","vertical","offset","node","type","nodes","values","io","connections","connection","options","cache","board","skip","track","add","outputNodes","substitution","output","getNodes","inputNodes","input","n","getNodesBoard","el","view","get","height","clientWidth","width","clientHeight","x","y","position","translate","updateConnections","toArray","currentMargin","currentOffset","column","sizes","getNodeSize","columnWidth","Math","max","size","fullHeight","reduce","sum","translateNode","install","bind","ar","on","arrange","console","log","name"],"mappings":"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"}